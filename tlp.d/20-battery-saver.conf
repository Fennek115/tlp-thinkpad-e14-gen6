# ==============================================================================
# TLP Drop-in Configuration: Battery Mode (Standard Power Saving)
# ==============================================================================
# File: /etc/tlp.d/20-battery-saver.conf
# Purpose: Configuration for battery operation with good balance
# Version: 2.0 - Updated with complete parameters per TLP 1.9.1
# Last modified: 2026-02-16
# ==============================================================================
#
# This file defines system behavior when operating on battery power.
# The goal is to maximize battery life while maintaining acceptable
# performance for daily tasks such as web browsing, office work,
# programming, and light multimedia.
#
# This configuration should give you 4-6 hours of typical use on your
# ThinkPad E14 Gen 6, depending on workload and screen brightness.
#
# ==============================================================================

# ------------------------------------------------------------------------------
# CPU: Balance Between Duration and Performance
# ------------------------------------------------------------------------------

# Energy/Performance Policy (EPP)
# "power" is an aggressive power-saving policy that reduces voltages and
# frequencies when possible. The Intel Core Ultra 5 125U responds very well
# to this mode, reducing consumption from ~12W to ~4-6W in light tasks
# without feeling sluggish in daily use.
CPU_ENERGY_PERF_POLICY_ON_BAT=power

# Performance limits
# Limit to 80% of maximum performance. This prevents CPU from reaching
# its highest (and most power-hungry) frequencies unnecessarily.
# With 80%, CPU can burst up to approximately 3.0-3.2 GHz when needed,
# which is sufficient for most tasks.
CPU_MIN_PERF_ON_BAT=0
CPU_MAX_PERF_ON_BAT=80

# Turbo Boost
# Disable turbo boost on battery. Turbo boost allows CPU to exceed its
# base frequency (in your case, reaching 4.3+ GHz), but this consumes
# a lot of power. By disabling it, CPU stays in more efficient frequency
# ranges (typically 1.0-2.5 GHz) without the system feeling slow for
# normal use.
#
# Note: If you find specific applications feel slow (e.g., code compilation),
# you can temporarily enable turbo with:
# echo 0 | sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo
CPU_BOOST_ON_BAT=0

# HWP Dynamic Boost (NEW - IMPORTANT)
# Disable dynamic boost on battery to avoid unnecessary consumption spikes
# when system responds to I/O events.
# On AC this improves responsiveness, but on battery we prefer efficiency.
CPU_HWP_DYN_BOOST_ON_BAT=0

# ------------------------------------------------------------------------------
# Platform Profile: Low Power
# ------------------------------------------------------------------------------

# The "low-power" platform profile optimizes the entire processor subsystem,
# not just CPU cores but also memory controllers, I/O, and other SoC
# components. This can save an additional 1-2W compared to just changing
# CPU EPP.
PLATFORM_PROFILE_ON_BAT=low-power

# ------------------------------------------------------------------------------
# Disk and Filesystem
# ------------------------------------------------------------------------------

# Laptop Mode
# Wait 2 seconds after disk becomes idle before syncing changes.
# This reduces frequency with which the disk (or SSD) needs to wake
# from low power states.
DISK_IDLE_SECS_ON_BAT=2

# Dirty pages
# Allow changes in memory to accumulate up to 60 seconds before forcing
# a write to disk. This reduces disk activity and allows it to remain
# in low power states for longer.
MAX_LOST_WORK_SECS_ON_BAT=60

# ------------------------------------------------------------------------------
# NVMe / SSD: Runtime Power Management (NEW - IMPORTANT)
# ------------------------------------------------------------------------------

# Runtime PM for AHCI/NVMe controllers and disks
# On battery: 'auto' = enabled, allows controller to enter low power
# states when not actively in use.
#
# This can save 0.5-1W when NVMe is not actively reading/writing.
AHCI_RUNTIME_PM_ON_BAT=auto

# Timeout: seconds of inactivity before controller suspends
# 15 seconds is a good balance between power saving and responsiveness.
# Lower values save more power but may add latency.
#
# Note: This is a global parameter (applies to both AC and BAT)
AHCI_RUNTIME_PM_TIMEOUT=15

# ------------------------------------------------------------------------------
# Intel Integrated Graphics
# ------------------------------------------------------------------------------

# For modern Intel graphics (like Arc Graphics in your Core Ultra 5 125U),
# the i915 driver already does an excellent job with automatic power
# management. In most cases, it's better NOT to manually limit frequencies
# and let the driver handle GPU efficiently based on load.
#
# The driver automatically:
# - Reduces frequencies when there's no graphics load
# - Increases frequencies only when there's GPU work
# - Respects system power profiles
#
# Only uncomment if monitoring with 'sudo intel_gpu_top' shows GPU
# constantly at high frequencies without reason and you want to force a limit:
#
#INTEL_GPU_MIN_FREQ_ON_BAT=800
#INTEL_GPU_MAX_FREQ_ON_BAT=1200    # Would limit to ~65% of max (1850 MHz)
#INTEL_GPU_BOOST_FREQ_ON_BAT=1200

# ------------------------------------------------------------------------------
# SATA and Storage
# ------------------------------------------------------------------------------

# ALPM for SATA
# Use same value as AC because "med_power_with_dipm" already provides
# good balance. If you have NVMe (most likely on your laptop), this
# setting doesn't apply but doesn't cause issues either.
SATA_LINKPWR_ON_BAT=med_power_with_dipm

# ------------------------------------------------------------------------------
# PCIe and System Devices
# ------------------------------------------------------------------------------

# ASPM for PCIe
# "powersupersave" is the most aggressive power-saving mode for PCIe
# devices. Can save an additional 1-2W by putting PCIe links in deeper
# low power states when not in use.
PCIE_ASPM_ON_BAT=powersupersave

# Runtime Power Management
# "auto" allows kernel to put PCIe devices in low power states when
# not actively in use. This is especially effective for network controllers,
# audio, and other peripherals.
RUNTIME_PM_ON_BAT=auto

# ------------------------------------------------------------------------------
# Audio
# ------------------------------------------------------------------------------

# Audio power saving
# Enable with 1 second timeout. This puts audio codec in low power state
# after 1 second of silence. The 1 second value is recommended for systems
# with PulseAudio/PipeWire.
SOUND_POWER_SAVE_ON_BAT=1
SOUND_POWER_SAVE_CONTROLLER=Y

# ------------------------------------------------------------------------------
# Wi-Fi
# ------------------------------------------------------------------------------

# Wi-Fi power saving
# Enable power saving on Wi-Fi. This allows the adapter to enter low
# power states between transmissions. May add 1-2ms of additional latency,
# but saves significant power and is not noticeable in normal use.
WIFI_PWR_ON_BAT=on

# ------------------------------------------------------------------------------
# USB
# ------------------------------------------------------------------------------

# USB Autosuspend
# Enable autosuspend for USB devices. This can save considerable power
# if you have USB devices connected that are not in constant use.
USB_AUTOSUSPEND=1

# Automatic exceptions
# TLP automatically excludes HID devices (mouse, keyboard) and scanners,
# but we enable these settings to be explicit.
USB_EXCLUDE_AUDIO=1
USB_EXCLUDE_BTUSB=0
USB_EXCLUDE_PHONE=0
USB_EXCLUDE_PRINTER=1
USB_EXCLUDE_WWAN=0

# ==============================================================================
# Notes about this configuration:
# ==============================================================================
#
# This configuration is optimized to give you good battery life (4-6 hours
# typical) while maintaining perfectly usable performance for daily work.
# It's not the most aggressive configuration possible (that's the SAV/
# ultra-power-saver mode), but a practical balance.
#
# Expected power consumption reduction vs default configuration:
#   - CPU idle: from ~12W to ~4-6W (50-60% reduction)
#   - Complete system idle: from ~16W to ~6-8W (50-60% reduction)
#   - Battery life: +60-80% compared to default configuration
#
# Tasks that work well with this configuration:
#   ✓ Web browsing (multiple tabs)
#   ✓ Office work (documents, spreadsheets, presentations)
#   ✓ Programming and development (code editors, terminals)
#   ✓ Multimedia (music, video playback up to 1080p)
#   ✓ Video conferencing (Zoom, Meet, Teams)
#   ✓ Email and communication
#
# Tasks that may feel slower:
#   ⚠ Large code compilation (but acceptable)
#   ⚠ Photo/video editing (better with AC)
#   ⚠ Gaming (definitely requires AC)
#   ⚠ Virtual machines (better with AC)
#
# If a specific task feels slow, you can always:
#   1. Connect the charger (automatic switch to AC profile)
#   2. Use performance mode manually: sudo tlp performance
#   3. Adjust CPU_MAX_PERF_ON_BAT to a higher value (e.g., 90)
#
# CHANGELOG v2.0:
# - Added CPU_HWP_DYN_BOOST_ON_BAT=0 (disable dynamic boost)
# - Added AHCI_RUNTIME_PM_ON_BAT=auto (NVMe management)
# - Added AHCI_RUNTIME_PM_TIMEOUT=15 (suspend timeout)
# - Improved Intel GPU documentation (leave unconfigured)
# - Clarified difference with SAV mode
#
# ==============================================================================
