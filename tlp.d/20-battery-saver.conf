# ==============================================================================
# TLP Drop-in Configuration: Battery Mode (Ahorro Estándar)
# ==============================================================================
# Archivo: /etc/tlp.d/20-battery-saver.conf
# Propósito: Configuración para uso en batería con buen balance
# Versión: 2.0 - Actualizada con parámetros completos según TLP 1.9.1
# Última modificación: 2026-02-16
# ==============================================================================
#
# Este archivo define el comportamiento del sistema cuando opera con batería.
# El objetivo es maximizar la duración de la batería mientras mantienes un
# rendimiento aceptable para tareas cotidianas como navegación web, ofimática,
# programación, y multimedia ligero.
#
# Esta configuración te debería dar entre 4-6 horas de uso típico en tu
# ThinkPad E14 Gen 6, dependiendo de la carga de trabajo y el brillo de
# la pantalla.
#
# ==============================================================================

# ------------------------------------------------------------------------------
# CPU: Balance entre Duración y Rendimiento
# ------------------------------------------------------------------------------

# Política de energía (EPP)
# "power" es una política agresiva de ahorro que reduce voltajes y
# frecuencias cuando sea posible. El Intel Core Ultra 5 125U responde
# muy bien a este modo, reduciendo el consumo de ~12W a ~4-6W en tareas
# ligeras sin sentirse lento en uso diario.
CPU_ENERGY_PERF_POLICY_ON_BAT=power

# Límites de rendimiento
# Limitamos al 80% del rendimiento máximo. Esto previene que el CPU
# alcance sus frecuencias más altas (y más hambrientas de energía)
# innecesariamente. Con 80%, el CPU puede llegar hasta aproximadamente
# 3.0-3.2 GHz en ráfagas cuando lo necesite, que es suficiente para
# la mayoría de tareas.
CPU_MIN_PERF_ON_BAT=0
CPU_MAX_PERF_ON_BAT=80

# Turbo Boost
# Deshabilitamos el turbo boost en batería. El turbo boost permite que
# el CPU supere su frecuencia base (en tu caso, llegar a 4.3+ GHz), pero
# esto consume mucha energía. Al deshabilitarlo, el CPU se mantiene en
# rangos de frecuencia más eficientes (típicamente 1.0-2.5 GHz) sin que
# el sistema se sienta lento para uso normal.
#
# Nota: Si encuentras que algunas aplicaciones específicas se sienten
# lentas (por ejemplo, compilación de código), puedes habilitar el turbo
# temporalmente con: echo 0 | sudo tee /sys/devices/system/cpu/intel_pstate/no_turbo
CPU_BOOST_ON_BAT=0

# HWP Dynamic Boost (NUEVO - IMPORTANTE)
# Deshabilitamos el dynamic boost en batería para evitar picos de consumo
# innecesarios cuando el sistema responde a eventos de I/O.
# En AC esto mejora la respuesta, pero en batería preferimos la eficiencia.
CPU_HWP_DYN_BOOST_ON_BAT=0

# ------------------------------------------------------------------------------
# Platform Profile: Bajo Consumo
# ------------------------------------------------------------------------------

# El platform profile "low-power" optimiza todo el subsistema del procesador,
# no solo los cores de CPU sino también los controladores de memoria, I/O,
# y otros componentes del SoC. Esto puede ahorrar 1-2W adicionales comparado
# con solo cambiar el EPP del CPU.
PLATFORM_PROFILE_ON_BAT=low-power

# ------------------------------------------------------------------------------
# Disco y Sistema de Archivos
# ------------------------------------------------------------------------------

# Laptop Mode
# Esperamos 2 segundos después de que el disco quede inactivo antes de
# sincronizar los cambios. Esto reduce la frecuencia con la que el disco
# (o SSD) necesita despertar de estados de bajo consumo.
DISK_IDLE_SECS_ON_BAT=2

# Dirty pages
# Permitimos que los cambios en memoria se acumulen hasta 60 segundos
# antes de forzar una escritura al disco. Esto reduce la actividad del
# disco y permite que permanezca en estados de bajo consumo por más tiempo.
MAX_LOST_WORK_SECS_ON_BAT=60

# ------------------------------------------------------------------------------
# NVMe / SSD: Runtime Power Management (NUEVO - IMPORTANTE)
# ------------------------------------------------------------------------------

# Runtime PM para controladores AHCI/NVMe y discos
# En batería: 'auto' = habilitado, permite que el controlador entre en
# estados de bajo consumo cuando no está en uso activo.
#
# Esto puede ahorrar 0.5-1W cuando el NVMe no está activamente leyendo/escribiendo.
AHCI_RUNTIME_PM_ON_BAT=auto

# Timeout: segundos de inactividad antes de que el controlador se suspenda
# 15 segundos es un buen balance entre ahorro de energía y respuesta.
# Valores más bajos ahorran más energía pero pueden añadir latencia.
#
# Nota: Este es un parámetro global (aplica tanto a AC como a BAT)
AHCI_RUNTIME_PM_TIMEOUT=15

# ------------------------------------------------------------------------------
# Gráficos Intel Integrados
# ------------------------------------------------------------------------------

# Para gráficos Intel modernos (como la Arc Graphics en tu Core Ultra 5 125U),
# el driver i915 ya hace un excelente trabajo de gestión automática de energía.
# En la mayoría de casos, es mejor NO limitar manualmente las frecuencias y
# dejar que el driver maneje la GPU eficientemente según la carga.
#
# El driver automáticamente:
# - Baja frecuencias cuando no hay carga gráfica
# - Aumenta frecuencias solo cuando hay trabajo de GPU
# - Respeta los perfiles de energía del sistema
#
# Solo descomenta si monitoreando con 'sudo intel_gpu_top' detectas que la GPU
# está constantemente a altas frecuencias sin razón y quieres forzar un límite:
#
#INTEL_GPU_MIN_FREQ_ON_BAT=800
#INTEL_GPU_MAX_FREQ_ON_BAT=1200    # Limitaría a ~65% del máximo (1850 MHz)
#INTEL_GPU_BOOST_FREQ_ON_BAT=1200

# ------------------------------------------------------------------------------
# SATA y Almacenamiento
# ------------------------------------------------------------------------------

# ALPM para SATA
# Usamos el mismo valor que en AC porque "med_power_with_dipm" ya da
# un buen balance. Si tienes un NVMe (que es lo más probable en tu laptop),
# esta configuración no aplica pero tampoco causa problemas.
SATA_LINKPWR_ON_BAT=med_power_with_dipm

# ------------------------------------------------------------------------------
# PCIe y Dispositivos del Sistema
# ------------------------------------------------------------------------------

# ASPM para PCIe
# "powersupersave" es el modo más agresivo de ahorro de energía para
# dispositivos PCIe. Puede ahorrar 1-2W adicionales poniendo los enlaces
# PCIe en estados de bajo consumo más profundos cuando no están en uso.
PCIE_ASPM_ON_BAT=powersupersave

# Runtime Power Management
# "auto" permite que el kernel ponga dispositivos PCIe en estados de
# bajo consumo cuando no están activamente en uso. Esto es especialmente
# efectivo para controladores de red, audio, y otros periféricos.
RUNTIME_PM_ON_BAT=auto

# ------------------------------------------------------------------------------
# Audio
# ------------------------------------------------------------------------------

# Audio power saving
# Habilitamos con 1 segundo de timeout. Esto pone el codec de audio en
# estado de bajo consumo después de 1 segundo de silencio. El valor de 1
# segundo es recomendado para sistemas con PulseAudio/PipeWire.
SOUND_POWER_SAVE_ON_BAT=1
SOUND_POWER_SAVE_CONTROLLER=Y

# ------------------------------------------------------------------------------
# Wi-Fi
# ------------------------------------------------------------------------------

# Wi-Fi power saving
# Habilitamos el ahorro de energía en Wi-Fi. Esto permite que el
# adaptador entre en estados de bajo consumo entre transmisiones.
# Puede añadir 1-2ms de latencia adicional, pero ahorra energía
# significativa y no es notable en uso normal.
WIFI_PWR_ON_BAT=on

# ------------------------------------------------------------------------------
# USB
# ------------------------------------------------------------------------------

# USB Autosuspend
# Habilitamos el autosuspend para dispositivos USB. Esto puede ahorrar
# bastante energía si tienes dispositivos USB conectados que no están
# en uso constante.
USB_AUTOSUSPEND=1

# Excepciones automáticas
# TLP automáticamente excluye dispositivos HID (mouse, teclado) y
# scanners, pero habilitamos estas configuraciones para ser explícitos.
USB_EXCLUDE_AUDIO=1
USB_EXCLUDE_BTUSB=0
USB_EXCLUDE_PHONE=0
USB_EXCLUDE_PRINTER=1
USB_EXCLUDE_WWAN=0

# ==============================================================================
# Notas sobre esta configuración:
# ==============================================================================
#
# Esta configuración está optimizada para darte una buena duración de batería
# (4-6 horas típicas) mientras mantienes un rendimiento perfectamente usable
# para trabajo diario. No es la configuración más agresiva posible (para eso
# está el modo SAV/ultra-ahorro), sino un balance práctico.
#
# Reducción esperada de consumo vs configuración por defecto:
#   - CPU idle: de ~12W a ~4-6W (50-60% de reducción)
#   - Sistema completo idle: de ~16W a ~6-8W (50-60% de reducción)
#   - Duración de batería: +60-80% comparado con configuración por defecto
#
# Qué tareas funcionan bien con esta configuración:
#   ✓ Navegación web (múltiples pestañas)
#   ✓ Ofimática (documentos, hojas de cálculo, presentaciones)
#   ✓ Programación y desarrollo (editores de código, terminales)
#   ✓ Multimedia (música, video playback hasta 1080p)
#   ✓ Videoconferencias (Zoom, Meet, Teams)
#   ✓ Email y comunicación
#
# Qué tareas pueden sentirse más lentas:
#   ⚠ Compilación de código grande (pero aceptable)
#   ⚠ Edición de foto/video (mejor con AC)
#   ⚠ Gaming (definitivamente requiere AC)
#   ⚠ Máquinas virtuales (mejor con AC)
#
# Si una tarea específica se siente lenta, siempre puedes:
#   1. Conectar el cargador (cambio automático a perfil AC)
#   2. Usar el modo performance manualmente: sudo tlp performance
#   3. Ajustar CPU_MAX_PERF_ON_BAT a un valor mayor (ej: 90)
#
# CHANGELOG v2.0:
# - Agregado CPU_HWP_DYN_BOOST_ON_BAT=0 (deshabilitar dynamic boost)
# - Agregado AHCI_RUNTIME_PM_ON_BAT=auto (gestión de NVMe)
# - Agregado AHCI_RUNTIME_PM_TIMEOUT=15 (timeout de suspensión)
# - Mejorada documentación sobre GPU Intel (dejar sin configurar)
# - Aclarada diferencia con modo SAV
#
# ==============================================================================
